<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Breaker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>

</head>
<body>
    <h1>Code Structure Visualizer</h1>

    <form method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".py" required>
        <button type="submit">Analyze File</button>
    </form>

    {% if error %}
        <p class="error">Error: {{ error }}</p>
    {% endif %}

    <svg width="960" height="500"></svg>

    <div id="code-display">
        Click on a node (class or function) to see its code here.
    </div>

    <script>
        const codeStructure = {{ code_structure_json | safe }};
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const g = svg.append("g").attr("transform", "translate(40,0)"); // Adjust margin for labels

        if (codeStructure && codeStructure.children && codeStructure.children.length > 0) {
            const treeLayout = d3.tree().size([height, width - 160]); // Adjust width for labels

            const root = d3.hierarchy(codeStructure);
            treeLayout(root);

            // Links
            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x));

            // Nodes
            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", d => "node" + (d.children ? " node--internal" : " node--leaf"))
                .attr("transform", d => `translate(${d.y},${d.x})`);

            node.append("circle")
                .attr("r", 10)
                .style("cursor", d => d.data.code ? "pointer" : "default"); // Add cursor pointer if code exists

            node.append("text")
                .attr("dy", ".35em")
                .attr("x", d => d.children ? -13 : 13)
                .style("text-anchor", d => d.children ? "end" : "start")
                .text(d => `${d.data.name} (${d.data.type || 'module'})`);

            const codeDisplay = d3.select("#code-display");

            // Add click listener to nodes
            node.on("click", function(event, d) {
                event.stopPropagation(); // Prevent click from bubbling up to the body
                // Remove selected class from all circles
                g.selectAll(".node circle").classed("selected", false);

                if (d.data.code) {
                    // Add selected class to the clicked circle
                    d3.select(this).select("circle").classed("selected", true);
                    codeDisplay.text(d.data.code);
                    codeDisplay.classed("visible", true); // Show the drawer
                } else {
                    // If node has no code, hide the drawer
                    codeDisplay.classed("visible", false);
                    if (d.data.type !== 'root') {
                        // Optionally, show a message briefly or handle differently
                        console.log(`No specific code snippet available for ${d.data.name} (${d.data.type}).`);
                    }
                }
            });

            // Add click listener to the body to hide the drawer when clicking outside
            d3.select("body").on("click", function() {
                codeDisplay.classed("visible", false);
                g.selectAll(".node circle").classed("selected", false); // Deselect nodes
            });

            // Prevent clicks inside the code display from closing it
            codeDisplay.on("click", function(event) {
                event.stopPropagation();
            });
        } else if (!{{ error | tojson }}) {
             g.append("text")
              .attr("x", width / 2)
              .attr("y", height / 2)
              .attr("text-anchor", "middle")
              .text("Upload a Python file to see its structure.");
        }

    </script>
</body>
</html>